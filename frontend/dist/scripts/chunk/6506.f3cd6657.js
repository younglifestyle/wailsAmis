"use strict";(self.webpackChunktestAmis=self.webpackChunktestAmis||[]).push([[6506],{46506:function(e,t,r){r.r(t),r.d(t,{Log:function(){return c},LogRenderer:function(){return u}});var s=r(31635),n=r(96540),i=r(8096),o=r(65408),l={30:"black",31:"red",32:"green",33:"yellow",34:"blue",35:"magenta",36:"cyan",37:"white",90:"grey"},a={40:"black",41:"red",42:"green",43:"yellow",44:"blue",45:"magenta",46:"cyan",47:"white"},c=function(e){function t(t){var r=e.call(this,t)||this;return r.isDone=!1,r.autoScroll=!1,r.state={lastLine:"",logs:[],originLastLine:"",originLogs:[],refresh:!0,showLineNumber:!1,filterWord:""},r.refresh=function(e){var t=r.state.refresh;r.setState({refresh:!t}),t||(r.clear(e),r.loadLogs()),e.preventDefault()},r.clear=function(e){r.setState({logs:r.logs=[],lastLine:r.lastLine="",originLogs:[],originLastLine:""}),null==e||e.preventDefault()},r.filterWord=function(e,t,s){var n=e,i=t;""!==s&&null!=s&&s.length>0&&(e=e.filter((function(e){return e.includes(s)})),t.includes(s)||(t="")),r.setState({filterWord:s,lastLine:r.lastLine=t,logs:r.logs=e,originLogs:n,originLastLine:i})},r.addLines=function(e){e=e.concat();var t=r.props.maxLength,s=r.lastLine||"",n=(r.logs||[]).concat();1===e.length?(s+=e[0],r.setState({lastLine:r.lastLine=s})):(e[0]=s+(e[0]||""),s=e.pop()||"",t&&n.length+e.length>t&&n.splice(0,n.length+e.length-t),n=n.concat(e),r.filterWord(n,s,r.state.filterWord))},r.logRef=n.createRef(),r.autoScroll=t.autoScroll||!1,r.pauseOrResumeScrolling=r.pauseOrResumeScrolling.bind(r),r}return(0,s.C6)(t,e),t.prototype.componentWillUnmount=function(){this.logRef&&this.logRef.current&&this.logRef.current.removeEventListener("scroll",this.pauseOrResumeScrolling)},t.prototype.componentDidMount=function(){if(this.autoScroll&&this.logRef&&this.logRef.current&&this.logRef.current.addEventListener("scroll",this.pauseOrResumeScrolling),this.props.source){var e="string"==typeof this.props.source?(0,i.GvO)(this.props.source,this.props.data,"| raw"):this.props.source;e&&(0,i.Amo)(e)?this.loadLogs():("string"==typeof e||Array.isArray(e)&&e.every((function(e){return"string"==typeof e})))&&(this.clear(),this.addLines(Array.isArray(e)?e:[e]))}},t.prototype.componentDidUpdate=function(e){if(this.autoScroll&&this.logRef&&this.logRef.current&&(this.logRef.current.scrollTop=this.logRef.current.scrollHeight),this.props.source){var t="string"==typeof this.props.source?(0,i.GvO)(this.props.source,this.props.data,"| raw"):this.props.source;t&&(0,i.Amo)(t)?(0,i.B92)(e.source,this.props.source,e.data,this.props.data)&&this.loadLogs():("string"==typeof t||Array.isArray(t)&&t.every((function(e){return"string"==typeof e})))&&(0,i.GvO)(e.source,e.data,"| raw")!==t&&t&&(this.clear(),this.addLines(Array.isArray(t)?t:[t]))}},t.prototype.pauseOrResumeScrolling=function(){if(this.logRef&&this.logRef.current){var e=this.logRef.current,t=e.scrollHeight,r=e.scrollTop,s=e.offsetHeight;this.autoScroll=t-(r+s)<50}},t.prototype.loadLogs=function(){var e,t,r;return(0,s.sH)(this,void 0,void 0,(function(){var n,o,l,a,c,u,h,p,g,d,f,m,L,v,y,b,E,R=this;return(0,s.YH)(this,(function(s){switch(s.label){case 0:return n=this.props,o=n.source,l=n.data,a=n.env,c=n.translate,u=n.encoding,n.maxLength,h=n.credentials,p=void 0===h?"include":h,(g=(0,i.lSp)(o,l)).url?[4,fetch(g.url,{method:(null===(e=g.method)||void 0===e?void 0:e.toLocaleUpperCase())||"GET",headers:g.headers||void 0,body:g.data?JSON.stringify(g.data):void 0,credentials:p})]:[2];case 1:if(200!==(d=s.sent()).status)return[3,8];if(!(f=d.body))return[2];m=f.getReader(),s.label=2;case 2:return this.state.refresh?[3,4]:[4,m.cancel("click cancel button").then((function(){R.props.env.notify("success","日志已经停止刷新")}))];case 3:s.sent(),s.label=4;case 4:return[4,m.read()];case 5:if(L=s.sent(),v=L.done,(y=L.value)&&(b=new TextDecoder(u).decode(y,{stream:!0}),E=b.split("\n"),this.addLines(E)),v)return this.isDone=!0,[2];s.label=6;case 6:return[3,2];case 7:return[3,9];case 8:!g.silent&&a.notify("error",null!==(r=null===(t=null==g?void 0:g.messages)||void 0===t?void 0:t.failed)&&void 0!==r?r:c("fetchFailed")),s.label=9;case 9:return[2]}}))}))},t.prototype.ansiColrToHtml=function(e){if(!0===this.props.disableColor)return e;var t=e.match(/\u001b\[([^m]+)m/);if(t){var r=t[1];if(r){if(e=e.replace(/\u001b[^m]*?m/g,""),r in l)return n.createElement("span",{style:{color:l[r]}},e);if(r in a)return n.createElement("span",{style:{backgroundColor:a[r]}},e.replace(/\u001b[^m]*?m/g,""))}}return e},t.prototype.renderHighlightWord=function(e){var t=this,r=this.props.classnames,s=this.state.filterWord;if(""===s)return this.ansiColrToHtml(e);var i=e.split(s);return i.map((function(e,o){return o<i.length-1?n.createElement("span",null,t.ansiColrToHtml(e),n.createElement("span",{className:r("Log-line-highlight")},s)):e}))},t.prototype.renderLine=function(e,t,r){var s=this.props,i=s.classnames;return s.disableColor,n.createElement("div",{className:i("Log-line"),key:e},r&&n.createElement("span",{className:i("Log-line-number")},e+1," "),this.renderHighlightWord(t))},t.prototype.render=function(){var e=this,t=this.props,r=t.source,i=t.className,l=t.style,a=t.classnames,c=t.placeholder,u=t.height,h=t.rowHeight;t.disableColor;var p,g=t.translate,d=t.operation,f=this.state,m=f.refresh,L=f.showLineNumber,v=g(c);r||(v=g("Log.mustHaveSource"));var y=this.state.lastLine?this.state.logs.concat([this.state.lastLine]):this.state.logs,b=h;return p=b?n.createElement(o.wj,{height:u,itemCount:y.length,itemSize:h,renderItem:function(t){var r=t.index,i=t.style;return n.createElement("div",{className:a("Log-line"),key:r,style:(0,s.Cl)((0,s.Cl)({},i),{whiteSpace:"nowrap"})},L&&n.createElement("span",{className:a("Log-line-number")},r+1," "),e.renderHighlightWord(y[r]))}}):y.map((function(t,r){return e.renderLine(r,t,L)})),n.createElement("div",{className:a("Log",i),style:l},n.createElement("div",{className:a("Log-operation")},d&&(null==d?void 0:d.length)>0&&n.createElement(n.Fragment,null,d.includes("stop")&&n.createElement("a",{title:g("stop"),className:m?"":"is-disabled",onClick:this.refresh},n.createElement(o.In,{icon:"pause"})),d.includes("restart")&&n.createElement("a",{title:g("reload"),className:m?"is-disabled":"",onClick:this.refresh},n.createElement(o.In,{icon:"refresh"})),d.includes("showLineNumber")&&n.createElement("a",{title:g(L?"Log.notShowLineNumber":"Log.showLineNumber"),onClick:function(t){e.setState({showLineNumber:!L}),t.preventDefault()}},n.createElement(o.In,{icon:L?"invisible":"view"})),d.includes("clear")&&n.createElement("a",{onClick:this.clear,title:g("clear")},n.createElement(o.In,{icon:"remove"})),d&&d.includes("filter")&&n.createElement(o.Gd,{className:a("Log-filter-box"),placeholder:"过滤词",onChange:function(t){return e.filterWord(e.state.originLogs,e.state.lastLine,t)},value:this.state.filterWord}))),n.createElement("div",{ref:this.logRef,className:a("Log-body"),style:{height:b?"auto":u}},b||p.length?p:v))},t.defaultProps={height:500,autoScroll:!0,placeholder:"loading",encoding:"utf-8"},t}(n.Component),u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,s.C6)(t,e),(0,s.Cg)([(0,i.A49)({type:"log"})],t)}(c)}}]);