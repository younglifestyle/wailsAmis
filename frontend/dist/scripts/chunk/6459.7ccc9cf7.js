"use strict";(self.webpackChunktestAmis=self.webpackChunktestAmis||[]).push([[6459],{56459:function(t,e,r){r.r(e),r.d(e,{ServiceRenderer:function(){return m},default:function(){return f},eventTypes:function(){return v}});var a=r(31635),n=r(96540),o=r(43346),i=r.n(o),s=r(88055),d=r.n(s),c=r(8096),h=r(65408),u=r(11331),p=r.n(u),l=r(50346),v=["inited","onApiFetched","onSchemaApiFetched","onWsFetched"],f=function(t){function e(e){var r=t.call(this,e)||this;return r.dataProviders=r.initDataProviders(e.dataProvider),r.handleQuery=r.handleQuery.bind(r),r.handleAction=r.handleAction.bind(r),r.handleChange=r.handleChange.bind(r),r.reload=r.reload.bind(r),r.silentReload=r.silentReload.bind(r),r.initInterval=r.initInterval.bind(r),r.afterDataFetch=r.afterDataFetch.bind(r),r.afterSchemaFetch=r.afterSchemaFetch.bind(r),r.runDataProvider=r.runDataProvider.bind(r),r.dataProviderSetData=r.dataProviderSetData.bind(r),r}return(0,a.C6)(e,t),e.prototype.componentDidMount=function(){return(0,a.sH)(this,void 0,void 0,(function(){var t,e,r,n;return(0,a.YH)(this,(function(a){switch(a.label){case 0:return t=this.props,e=t.data,r=t.dispatchEvent,this.mounted=!0,[4,r("init",e,this)];case 1:return(null==(n=a.sent())?void 0:n.prevented)||this.initFetch(),[2]}}))}))},e.prototype.componentDidUpdate=function(t){var e,r=this,a=this.props,n=a.store,o=a.messages,i=o.fetchSuccess,s=o.fetchFailed;a.dataProvider!==t.dataProvider&&(this.dataProviders=this.initDataProviders(a.dataProvider),this.dataProviders&&(null===(e=this.dataProviders)||void 0===e?void 0:e.inited)&&this.runDataProvider("inited")),(0,c.B92)(t.api,a.api,t.data,a.data)&&(0,c.Amo)(a.api,n.data)&&n.fetchData(a.api,n.data,{successMessage:i,errorMessage:s}).then((function(t){r.runDataProvider("onApiFetched"),r.afterDataFetch(t)})),(0,c.B92)(t.schemaApi,a.schemaApi,t.data,a.data)&&(0,c.Amo)(a.schemaApi,n.data)&&n.fetchSchema(a.schemaApi,n.data,{successMessage:i,errorMessage:s}).then((function(t){r.runDataProvider("onSchemaApiFetched"),r.afterSchemaFetch(t)})),a.ws&&t.ws!==a.ws&&(this.socket&&this.socket.close(),this.socket=this.fetchWSData(a.ws,n.data)),(0,c.JQ)(t.defaultData,a.defaultData)&&n.reInitData(a.defaultData)},e.prototype.componentWillUnmount=function(){this.mounted=!1,this.runDataProviderUnsubscribe(),clearTimeout(this.timer),this.socket&&this.socket.close&&this.socket.close()},e.prototype.doAction=function(t,e,r,a){if("rebuild"===(null==t?void 0:t.actionType)){var n=this.props,o=n.schemaApi,i=n.store,s=n.dataProvider,d=n.messages,h=d.fetchSuccess,u=d.fetchFailed;i.updateData(a),clearTimeout(this.timer),(0,c.Amo)(o,i.data)&&i.fetchSchema(o,i.data,{successMessage:h,errorMessage:u}).then(this.afterSchemaFetch),s&&this.runDataProvider("inited")}},e.prototype.initFetch=function(){var t=this,e=this.props,r=e.schemaApi,a=e.initFetchSchema,n=e.api,o=e.ws,i=e.initFetch,s=e.initFetchOn,d=e.dataProvider,h=e.store,u=e.messages,p=u.fetchSuccess,l=u.fetchFailed;(0,c.Amo)(r,h.data,a)&&h.fetchSchema(r,h.data,{successMessage:p,errorMessage:l}).then((function(e){t.runDataProvider("onSchemaApiFetched"),t.afterSchemaFetch(e)})),(0,c.Amo)(n,h.data,i,s)&&h.fetchInitData(n,h.data,{successMessage:p,errorMessage:l}).then((function(e){t.runDataProvider("onApiFetched"),t.afterDataFetch(e)})),o&&(this.socket=this.fetchWSData(o,h.data)),d&&this.runDataProvider("inited")},e.prototype.initDataProviders=function(t){var e=this,r=p()(t)?d()(t):t,a={};if(r)if(p()(r))Object.keys(r).forEach((function(t){var n=e.normalizeProvider(r[t],t);a=i()(a,n||{})}));else{var n=this.normalizeProvider(r,"inited");a=i()(a,n||{})}return a},e.prototype.normalizeProvider=function(t,e){var r,a;if(void 0===e&&(e="inited"),!~v.indexOf(e))return null;if("function"==typeof t)return(r={})[e]=t,r;if("string"==typeof t){var n=(0,c.uPQ)(t,"data","setData","env");return n?((a={})[e]=n,a):null}return null},e.prototype.runDataProvider=function(t){return(0,a.sH)(this,void 0,void 0,(function(){var e,r,n,o;return(0,a.YH)(this,(function(a){switch(a.label){case 0:return this.runDataProviderUnsubscribe(t),e=this.props.store,(r=this.dataProviders)&&~v.indexOf(t)&&(n=r[t])&&"function"==typeof n?[4,n(e.data,this.dataProviderSetData,this.props.env)]:[3,2];case 1:"function"==typeof(o=a.sent())&&(this.dataProviderUnsubscribe||(this.dataProviderUnsubscribe={}),this.dataProviderUnsubscribe[t]=o),a.label=2;case 2:return[2]}}))}))},e.prototype.runDataProviderUnsubscribe=function(t){var e,r=this.dataProviderUnsubscribe;if(r)if(t){var a=r[t];try{a&&"function"==typeof a&&a()}catch(t){console.error(t)}}else null===(e=Object.keys(r))||void 0===e||e.forEach((function(t){var e=r[t];try{e&&"function"==typeof e&&e()}catch(t){console.error(t)}}))},e.prototype.dataProviderSetData=function(t){if(this.mounted){var e=this.props.store;e.updateData(t,void 0,!1),e.setHasRemoteData()}},e.prototype.fetchWSData=function(t,e){var r=this,a=this.props,n=a.env,o=a.store,i=(0,c.lSp)(t,e);n.wsFetcher(i,(function(t){var e,a,s,d,c=t;if("status"in t&&"data"in t&&(c=t.data,0!==t.status))return o.updateMessage(null!==(a=null===(e=null==i?void 0:i.messages)||void 0===e?void 0:e.failed)&&void 0!==a?a:t.msg,!0),void n.notify("error",null!==(d=null===(s=null==i?void 0:i.messages)||void 0===s?void 0:s.failed)&&void 0!==d?d:t.msg);o.updateData(c,void 0,!1,i.concatDataFields),o.setHasRemoteData(),r.runDataProvider("onWsFetched"),r.afterDataFetch({ok:!0,data:c})}),(function(t){o.updateMessage(t,!0),n.notify("error",t)}))},e.prototype.afterDataFetch=function(t){var e,r=(null==t?void 0:t.hasOwnProperty("ok"))?null!==(e=t.data)&&void 0!==e?e:{}:t,n=this.props,o=n.onBulkChange,i=n.dispatchEvent,s=n.store,d=n.formStore;(0,l._n)(s)&&(null==i||i("fetchInited",(0,c.ed2)(this.props.data,(0,a.Cl)((0,a.Cl)({},r),{__response:{msg:s.msg,error:s.error},responseData:r,responseStatus:void 0===(null==t?void 0:t.status)?s.error?1:0:null==t?void 0:t.status,responseMsg:s.msg}))),!(0,c.Ime)(r)&&o&&d&&o(r,!1,{type:"api"}),(null==t?void 0:t.ok)&&this.initInterval(r))},e.prototype.afterSchemaFetch=function(t){var e=this.props,r=e.onBulkChange,n=e.formStore,o=e.dispatchEvent,i=e.store;null==o||o("fetchSchemaInited",(0,a.Cl)((0,a.Cl)({},t),{__response:{msg:i.msg,error:i.error},responseData:t,responseStatus:void 0===(null==t?void 0:t.status)?i.error?1:0:null==t?void 0:t.status,responseMsg:i.msg})),n&&(null==t?void 0:t.data)&&r&&r&&r(t.data),this.initInterval(t)},e.prototype.initInterval=function(t){var e=this.props,r=e.interval,a=e.silentPolling,n=e.stopAutoRefreshWhen,o=e.data;return clearTimeout(this.timer),r&&this.mounted&&(!n||!(0,c.pgu)(n,(0,c.ed2)(o,t)))&&(this.timer=setTimeout(a?this.silentReload:this.reload,Math.max(r,1e3))),t},e.prototype.reload=function(t,e,r,n,o){return(0,a.sH)(this,void 0,void 0,(function(){var t,r,i,s,d,h,u,p,l;return(0,a.YH)(this,(function(a){switch(a.label){case 0:return e?[2,this.receive(e,void 0,o)]:(t=this.props,r=t.schemaApi,t.initFetchSchema,i=t.api,t.initFetch,t.initFetchOn,s=t.store,d=t.dataProvider,h=t.messages,u=h.fetchSuccess,p=h.fetchFailed,clearTimeout(this.timer),(0,c.Amo)(r,s.data)?[4,s.fetchSchema(r,s.data,{successMessage:u,errorMessage:p})]:[3,3]);case 1:return l=a.sent(),[4,this.runDataProvider("onApiFetched")];case 2:a.sent(),this.afterSchemaFetch(l),a.label=3;case 3:return(0,c.Amo)(i,s.data)?[4,s.fetchData(i,s.data,{silent:n,successMessage:u,errorMessage:p})]:[3,6];case 4:return l=a.sent(),[4,this.runDataProvider("onSchemaApiFetched")];case 5:a.sent(),this.afterDataFetch(l),a.label=6;case 6:return d?[4,this.runDataProvider("inited")]:[3,8];case 7:a.sent(),a.label=8;case 8:return[2,s.data]}}))}))},e.prototype.silentReload=function(t,e){this.reload(t,e,void 0,!0)},e.prototype.receive=function(t,e,r){return(0,a.sH)(this,void 0,void 0,(function(){return(0,a.YH)(this,(function(e){return this.props.store.updateData(t,void 0,r),[2,this.reload()]}))}))},e.prototype.handleQuery=function(t){var e=this;return this.props.api||this.props.schemaApi?(!(null==t?void 0:t.hasOwnProperty("orderBy"))||![this.props.api,this.props.schemaApi].every((function(r){return!r||!(0,c.B92)(r,r,e.props.store.data,(0,c.ed2)(e.props.store.data,t))})))&&void this.receive(t):!!this.props.onQuery&&this.props.onQuery(t)},e.prototype.reloadTarget=function(t,e){},e.prototype.handleDialogConfirm=function(t,e,r,a){this.props.store.closeDialog(!0,t)},e.prototype.handleDialogClose=function(t){void 0===t&&(t=!1),this.props.store.closeDialog(t)},e.prototype.openFeedback=function(t,e){var r=this;return new Promise((function(a){var n=r.props.store;n.setCurrentAction({type:"button",actionType:"dialog",dialog:t},r.props.resolveDefinitions),n.openDialog(e,void 0,(function(t){a(t)}),r.context)}))},e.prototype.handleAction=function(t,e,r,n,o){var i=this;void 0===n&&(n=!1);var s=this.props,d=s.onAction,h=s.store,u=s.env,p=s.api,l=s.translate;p&&"ajax"===e.actionType?(h.setCurrentAction(e,this.props.resolveDefinitions),h.saveRemote(e.api,r,{successMessage:l(e.messages&&e.messages.success),errorMessage:l(e.messages&&e.messages.failed)}).then((function(t){return(0,a.sH)(i,void 0,void 0,(function(){var r;return(0,a.YH)(this,(function(a){switch(a.label){case 0:return this.afterDataFetch(t),e.feedback&&(0,c.zNq)(e.feedback,h.data)?[4,this.openFeedback(e.feedback,h.data)]:[3,2];case 1:a.sent(),a.label=2;case 2:return(r=e.redirect&&(0,c.pbD)(e.redirect,h.data))&&u.jumpTo(r,e,h.data),e.reload&&this.reloadTarget((0,c.Wvn)(e.reload,h.data),h.data),[2]}}))}))})).catch((function(t){if(n||e.countDown)throw t}))):d(t,e,r,n,o||this.context)},e.prototype.handleChange=function(t,e,r,a){var n,o,i=this.props,s=i.store,d=i.formStore,c=i.onChange;"string"==typeof e&&(null===(o=(n=s).changeValue)||void 0===o||o.call(n,e,t),d&&(null==c||c(t,e,r,a)))},e.prototype.renderBody=function(){var t=this.props,e=t.render,r=t.store,a=t.body;return t.classnames,e("body",r.schema||a,{key:r.schemaKey||"body",loading:r.loading,onQuery:this.handleQuery,onAction:this.handleAction,onChange:this.handleChange})},e.prototype.render=function(){var t=this.props,e=t.className,r=t.style,o=t.store,i=t.render,s=t.env,d=t.classPrefix,c=t.classnames,u=t.loadingConfig,p=t.showErrorMsg,l=t.testIdBuilder;return n.createElement("div",(0,a.Cl)({className:c("".concat(d,"Service"),e),style:r},null==l?void 0:l.getTestId()),!s.forceSilenceInsideError&&o.error&&!1!==p?n.createElement(h.pM,{level:"danger",showCloseButton:!0,onClose:function(){return o.updateMessage("")}},o.msg):null,this.renderBody(),n.createElement(h.y$,{size:"lg",overlay:!0,key:"info",show:o.loading,loadingConfig:u}),i("modal",(0,a.Cl)((0,a.Cl)({},o.action&&o.action.dialog),{type:"dialog"}),{key:"dialog",data:o.dialogData,onConfirm:this.handleDialogConfirm,onClose:this.handleDialogClose,show:o.dialogOpen}))},e.defaultProps={messages:{fetchFailed:"fetchFailed"},showErrorMsg:!0},e.propsList=[],(0,a.Cg)([c.d6t,(0,a.Sn)("design:type",Function),(0,a.Sn)("design:paramtypes",[]),(0,a.Sn)("design:returntype",void 0)],e.prototype,"initFetch",null),(0,a.Cg)([c.d6t,(0,a.Sn)("design:type",Function),(0,a.Sn)("design:paramtypes",[Object]),(0,a.Sn)("design:returntype",void 0)],e.prototype,"initDataProviders",null),(0,a.Cg)([c.d6t,(0,a.Sn)("design:type",Function),(0,a.Sn)("design:paramtypes",[Object,String]),(0,a.Sn)("design:returntype",Object)],e.prototype,"normalizeProvider",null),(0,a.Cg)([c.d6t,(0,a.Sn)("design:type",Function),(0,a.Sn)("design:paramtypes",[Array,Object,Object,Array]),(0,a.Sn)("design:returntype",void 0)],e.prototype,"handleDialogConfirm",null),(0,a.Cg)([c.d6t,(0,a.Sn)("design:type",Function),(0,a.Sn)("design:paramtypes",[Object]),(0,a.Sn)("design:returntype",void 0)],e.prototype,"handleDialogClose",null),e}(n.Component),m=function(t){function e(e,r){var a=t.call(this,e)||this;return r.registerComponent(a),a}return(0,a.C6)(e,t),e.prototype.reload=function(e,r,n,o,i){return(0,a.sH)(this,void 0,void 0,(function(){var s;return(0,a.YH)(this,(function(a){return s=this.context,e?[2,s.reload(r?"".concat(e,"?").concat((0,c.Eqn)(r)):e,n)]:[2,t.prototype.reload.call(this,e,r,n,o,i)]}))}))},e.prototype.receive=function(e,r,n){return(0,a.sH)(this,void 0,void 0,(function(){var o;return(0,a.YH)(this,(function(a){return o=this.context,r?[2,o.send(r,e)]:[2,t.prototype.receive.call(this,e,r,n)]}))}))},e.prototype.componentWillUnmount=function(){t.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},e.prototype.reloadTarget=function(t,e){this.context.reload(t,e)},e.prototype.setData=function(t,e){return this.props.store.updateData(t,void 0,e)},e.prototype.getData=function(){return this.props.store.data},e.contextType=c.MzX,(0,a.Cg)([(0,c.A49)({type:"service",storeType:c.DtI.name,isolateScope:!0,storeExtendsData:function(t){return!t.formStore}}),(0,a.Sn)("design:paramtypes",[Object,Object])],e)}(f)}}]);