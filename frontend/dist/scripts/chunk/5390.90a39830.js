"use strict";(self.webpackChunktestAmis=self.webpackChunktestAmis||[]).push([[5390],{75390:function(t,e,n){n.r(e),n.d(e,{TaskRenderer:function(){return l},default:function(){return c}});var a=n(31635),r=n(96540),o=n(8096),i=n(46894),s=n.n(i),u=n(65408),c=function(t){function e(e){var n=t.call(this,e)||this;return n.state={items:e.items?e.items.concat():[]},n.handleLoaded=n.handleLoaded.bind(n),n.tick=n.tick.bind(n),n}return(0,a.C6)(e,t),e.prototype.componentDidMount=function(){this.tick(!!this.props.checkApi)},e.prototype.componentDidUpdate=function(t){var e=this.props;t.items!==e.items?this.setState({items:e.items?e.items.concat():[]}):(0,o.B92)(t.checkApi,e.checkApi,t.data,e.data)&&this.tick(!0)},e.prototype.componentWillUnmount=function(){clearTimeout(this.timer)},e.prototype.reload=function(){this.tick(!0)},e.prototype.tick=function(t){var e=this;void 0===t&&(t=!1);var n=this.props,a=n.loadingStatusCode,r=n.data,i=n.interval,s=n.checkApi,u=n.env,c=this.state.items;if(clearTimeout(this.timer),t||c.some((function(t){return t.status===a})))return i&&!(0,o.Amo)(s)?u.alert("checkApi 没有设置, 不能及时获取任务状态"):void((0,o.Amo)(s,r)&&u&&u.fetcher(s,r).then(this.handleLoaded).catch((function(t){return e.setState({error:t})})))},e.prototype.handleLoaded=function(t){if(!Array.isArray(t.data))return this.props.env.alert("返回格式不正确, 期望 response.data 为数组, 包含每个 task 的状态信息");this.setState({items:t.data});var e=this.props.interval;clearTimeout(this.timer),this.timer=setTimeout(this.tick,e)},e.prototype.submitTask=function(t,e,n){var r=this;void 0===n&&(n=!1);var i=this.props,u=i.submitApi,c=i.reSubmitApi,l=i.loadingStatusCode,p=i.errorStatusCode,d=i.data,f=i.env;if(!n&&!(0,o.Amo)(u))return f.alert("submitApi 没有配置");if(n&&!(0,o.Amo)(c))return f.alert("reSubmitApi 没有配置");this.setState(s()(this.state,{items:{$splice:[[e,1,(0,a.Cl)((0,a.Cl)({},t),{status:l})]]}}));var m=n?c:u;(0,o.Amo)(m,d)&&f&&f.fetcher(m,(0,o.ed2)(d,t)).then((function(t){if(t&&t.data)if(Array.isArray(t.data))r.handleLoaded(t);else{m&&m.replaceData;var e=r.state.items.map((function(e){return e.key===t.data.key?(0,a.Cl)((0,a.Cl)({},m.replaceData?{}:e),t.data):e}));r.handleLoaded((0,a.Cl)((0,a.Cl)({},t),{data:e}))}else clearTimeout(r.timer),r.timer=setTimeout(r.tick,4)})).catch((function(n){return r.setState(s()(r.state,{items:{$splice:[[e,1,(0,a.Cl)((0,a.Cl)({},t),{status:p,remark:n.message||n})]]}}))}))},e.prototype.render=function(){var t=this,e=this.props,n=e.classnames,a=e.className,o=e.style,i=e.tableClassName,s=e.taskNameLabel,c=e.operationLabel,l=e.statusLabel,p=e.remarkLabel,d=e.btnText,f=e.retryBtnText,m=e.btnClassName,h=e.retryBtnClassName,y=e.statusLabelMap,b=e.statusTextMap,g=e.readyStatusCode,v=e.loadingStatusCode,k=e.canRetryStatusCode,C=e.translate,E=e.render,A=e.loadingConfig,$=this.state.items,S=this.state.error;return r.createElement("div",{className:n("Table-content",a),style:o},r.createElement("table",{className:n("Table-table",i)},r.createElement("thead",null,r.createElement("tr",null,r.createElement("th",null,s),r.createElement("th",null,C(c)),r.createElement("th",null,l),r.createElement("th",null,p))),r.createElement("tbody",null,S?r.createElement("tr",null,r.createElement("td",{colSpan:4},r.createElement("div",{className:"text-danger"},S))):$.map((function(e,a){return r.createElement("tr",{key:a},r.createElement("td",null,r.createElement("span",{className:n("word-break")},e.label)),r.createElement("td",null,e.status==v?r.createElement(u.y$,{loadingConfig:A,show:!0,icon:"reload",spinnerClassName:n("Task-spinner")}):e.status==k?r.createElement("a",{onClick:function(){return t.submitTask(e,a,!0)},className:n("Button","Button--danger","Button--size-md",h||m)},f||d):r.createElement("a",{onClick:function(){return t.submitTask(e,a)},className:n("Button","Button--default","Button--size-md",m,{disabled:e.status!==g})},d)),r.createElement("td",null,r.createElement("span",{className:n("label",y&&y[e.status||0])},b&&b[e.status||0])),r.createElement("td",null,e.remark?E("".concat(a,"/remark"),e.remark):null))})))))},e.defaultProps={className:"",tableClassName:"",taskNameLabel:"任务名称",operationLabel:"Table.operation",statusLabel:"状态",remarkLabel:"备注说明",btnText:"上线",retryBtnText:"重试",btnClassName:"",retryBtnClassName:"",statusLabelMap:["label-warning","label-info","label-info","label-danger","label-success","label-danger"],statusTextMap:["未开始","就绪","进行中","出错","已完成","出错"],initialStatusCode:0,readyStatusCode:1,loadingStatusCode:2,errorStatusCode:3,finishStatusCode:4,canRetryStatusCode:5,interval:3e3},e}(r.Component),l=function(t){function e(e,n){var a=t.call(this,e)||this;return n.registerComponent(a),a}return(0,a.C6)(e,t),e.prototype.componentWillUnmount=function(){t.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},e.contextType=o.MzX,(0,a.Cg)([(0,o.A49)({type:"tasks"}),(0,a.Sn)("design:paramtypes",[Object,Object])],e)}(c)},46894:function(t,e){function n(t){return"object"!=typeof t||"toString"in t?t:Object.prototype.toString.call(t).slice(8,-1)}Object.defineProperty(e,"__esModule",{value:!0});var a="object"==typeof process&&!0;function r(t,e){if(!t){if(a)throw new Error("Invariant failed");throw new Error(e())}}e.invariant=r;var o=Object.prototype.hasOwnProperty,i=Array.prototype.splice,s=Object.prototype.toString;function u(t){return s.call(t).slice(8,-1)}var c=Object.assign||function(t,e){return l(e).forEach((function(n){o.call(e,n)&&(t[n]=e[n])})),t},l="function"==typeof Object.getOwnPropertySymbols?function(t){return Object.keys(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.keys(t)};function p(t){return Array.isArray(t)?c(t.constructor(t.length),t):"Map"===u(t)?new Map(t):"Set"===u(t)?new Set(t):t&&"object"==typeof t?c(Object.create(Object.getPrototypeOf(t)),t):t}var d=function(){function t(){this.commands=c({},f),this.update=this.update.bind(this),this.update.extend=this.extend=this.extend.bind(this),this.update.isEquals=function(t,e){return t===e},this.update.newContext=function(){return(new t).update}}return Object.defineProperty(t.prototype,"isEquals",{get:function(){return this.update.isEquals},set:function(t){this.update.isEquals=t},enumerable:!0,configurable:!0}),t.prototype.extend=function(t,e){this.commands[t]=e},t.prototype.update=function(t,e){var n=this,a="function"==typeof e?{$apply:e}:e;Array.isArray(t)&&Array.isArray(a)||r(!Array.isArray(a),(function(){return"update(): You provided an invalid spec to update(). The spec may not contain an array except as the value of $set, $push, $unshift, $splice or any custom command allowing an array value."})),r("object"==typeof a&&null!==a,(function(){return"update(): You provided an invalid spec to update(). The spec and every included key path must be plain objects containing one of the following commands: "+Object.keys(n.commands).join(", ")+"."}));var i=t;return l(a).forEach((function(e){if(o.call(n.commands,e)){var r=t===i;i=n.commands[e](a[e],i,a,t),r&&n.isEquals(i,t)&&(i=t)}else{var s="Map"===u(t)?n.update(t.get(e),a[e]):n.update(t[e],a[e]),c="Map"===u(i)?i.get(e):i[e];n.isEquals(s,c)&&(void 0!==s||o.call(t,e))||(i===t&&(i=p(t)),"Map"===u(i)?i.set(e,s):i[e]=s)}})),i},t}();e.Context=d;var f={$push:function(t,e,n){return h(e,n,"$push"),t.length?e.concat(t):e},$unshift:function(t,e,n){return h(e,n,"$unshift"),t.length?t.concat(e):e},$splice:function(t,e,a,o){return function(t,e){r(Array.isArray(t),(function(){return"Expected $splice target to be an array; got "+n(t)})),b(e.$splice)}(e,a),t.forEach((function(t){b(t),e===o&&t.length&&(e=p(o)),i.apply(e,t)})),e},$set:function(t,e,n){return function(t){r(1===Object.keys(t).length,(function(){return"Cannot have more than one key in an object with $set"}))}(n),t},$toggle:function(t,e){y(t,"$toggle");var n=t.length?p(e):e;return t.forEach((function(t){n[t]=!e[t]})),n},$unset:function(t,e,n,a){return y(t,"$unset"),t.forEach((function(t){Object.hasOwnProperty.call(e,t)&&(e===a&&(e=p(a)),delete e[t])})),e},$add:function(t,e,n,a){return g(e,"$add"),y(t,"$add"),"Map"===u(e)?t.forEach((function(t){var n=t[0],r=t[1];e===a&&e.get(n)!==r&&(e=p(a)),e.set(n,r)})):t.forEach((function(t){e!==a||e.has(t)||(e=p(a)),e.add(t)})),e},$remove:function(t,e,n,a){return g(e,"$remove"),y(t,"$remove"),t.forEach((function(t){e===a&&e.has(t)&&(e=p(a)),e.delete(t)})),e},$merge:function(t,e,a,o){var i,s;return i=e,r((s=t)&&"object"==typeof s,(function(){return"update(): $merge expects a spec of type 'object'; got "+n(s)})),r(i&&"object"==typeof i,(function(){return"update(): $merge expects a target of type 'object'; got "+n(i)})),l(t).forEach((function(n){t[n]!==e[n]&&(e===o&&(e=p(o)),e[n]=t[n])})),e},$apply:function(t,e){var a;return r("function"==typeof(a=t),(function(){return"update(): expected spec of $apply to be a function; got "+n(a)+"."})),t(e)}},m=new d;function h(t,e,a){r(Array.isArray(t),(function(){return"update(): expected target of "+n(a)+" to be an array; got "+n(t)+"."})),y(e[a],a)}function y(t,e){r(Array.isArray(t),(function(){return"update(): expected spec of "+n(e)+" to be an array; got "+n(t)+". Did you forget to wrap your parameter in an array?"}))}function b(t){r(Array.isArray(t),(function(){return"update(): expected spec of $splice to be an array of arrays; got "+n(t)+". Did you forget to wrap your parameters in an array?"}))}function g(t,e){var a=u(t);r("Map"===a||"Set"===a,(function(){return"update(): "+n(e)+" expects a target of type Set or Map; got "+n(a)}))}e.isEquals=m.update.isEquals,e.extend=m.extend,e.default=m.update,e.default.default=t.exports=c(e.default,e)}}]);