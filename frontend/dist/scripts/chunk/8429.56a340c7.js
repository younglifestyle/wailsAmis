"use strict";(self.webpackChunktestAmis=self.webpackChunktestAmis||[]).push([[8429],{48429:function(e,t,n){n.r(t),n.d(t,{PickerControlRenderer:function(){return O},default:function(){return F}});var i=n(31635),o=n(96540),s=n(32485),r=n.n(s),l=n(90179),a=n.n(l),c=n(7309),p=n.n(c),d=n(2404),u=n.n(d),h=n(24713),m=n.n(h),v=n(55364),f=n.n(v),g=n(8096),y=n(65408),C=n(80191),k=n.n(C),S=n(66283),b=n(22451),F=function(e){function t(t){var n=e.call(this,t)||this;n.state={isOpened:!1,schema:n.buildSchema(n.props),isFocused:!1},n.input=o.createRef(),n.toDispose=[],n.mounted=!1;var s=t.formInited,r=t.addHook,l=t.formItem,a=function(){return(0,i.sH)(n,void 0,void 0,(function(){var e=this;return(0,i.YH)(this,(function(t){switch(t.label){case 0:return[4,this.fetchOptions()];case 1:return t.sent(),this.mounted&&this.toDispose.push((0,b.mJ)((function(){return JSON.stringify(null==l?void 0:l.tmpValue)}),(function(){return e.fetchOptions()}))),[2]}}))}))};return l&&n.toDispose.push(s||!r?l.addInitHook(a):r(a,"init")),n}return(0,i.C6)(t,e),t.prototype.componentDidMount=function(){this.mounted=!0},t.prototype.componentDidUpdate=function(e){var t,n=this.props;["multiple","source","pickerSchema"].some((function(t){return!u()(e[t],n[t])}))?this.setState({schema:this.buildSchema(n)}):(0,g.B92)(e.source,n.source,e.data,n.data)&&(null===(t=n.formItem)||void 0===t?void 0:t.inited)&&this.fetchOptions()},t.prototype.componentWillUnmount=function(){this.toDispose.forEach((function(e){return e()})),this.toDispose=[],this.mounted=!1},t.prototype.fetchOptions=function(){var e,t,n=this.props,i=n.value,o=n.formItem,s=n.valueField,r=n.labelField,l=n.source,a=n.data;if(l&&o&&(s||"value")!==(r||"label")&&(!(t=o.getSelectedOptions(i))||t.length&&t[0][s||"value"]===t[0][r||"label"])){var c=(0,g.ed2)(a,((e={value:i})[s||"value"]=i,e.op="loadOptions",e));if((0,g.joH)(l))o.setOptions((0,g.GvO)(l,a,"| raw"));else if((0,g.Amo)(l,c))return o.loadOptions(l,c,{autoAppend:!0})}},t.prototype.buildSchema=function(e){var t,n,o=(0,g.joH)(e.source);return(0,i.Cl)((0,i.Cl)({checkOnItemClick:!0,listItem:{title:"${".concat(e.labelField||"label","|raw}")}},e.pickerSchema),{labelTpl:null!==(n=null===(t=e.pickerSchema)||void 0===t?void 0:t.labelTpl)&&void 0!==n?n:e.labelTpl,type:"crud",pickerMode:!0,syncLocation:!1,filterCanAccessSuperData:!1,api:o?null:e.source,source:o?e.source:null,keepItemSelectionOnPageChange:!0,valueField:e.valueField,labelField:e.labelField,bulkActions:e.multiple?e.pickerSchema.bulkActions:[]})},t.prototype.crudRef=function(e){for(;e&&e.getWrappedInstance;)e=e.getWrappedInstance();this.crud=e},t.prototype.reload=function(){if(this.crud)this.crud.search();else{var e=this.props.reloadOptions;e&&e()}},t.prototype.open=function(){this.setState({isOpened:!0})},t.prototype.close=function(){this.setState({isOpened:!1})},t.prototype.handleModalConfirm=function(e,t,n,o){return(0,i.sH)(this,void 0,void 0,(function(){var t;return(0,i.YH)(this,(function(n){switch(n.label){case 0:return t=m()(o,(function(e){return"crud"===e.props.type})),[4,this.handleChange(e[t].items)];case 1:return n.sent(),this.close(),[2]}}))}))},t.prototype.handleChange=function(e){return(0,i.sH)(this,void 0,void 0,(function(){var t,n,o,s,r,l,a,c,d,u,h,m,v,f;return(0,i.YH)(this,(function(i){switch(i.label){case 0:return t=this.props,n=t.joinValues,o=t.valueField,s=t.delimiter,r=t.extractValue,l=t.multiple,a=t.options,t.data,c=t.dispatchEvent,t.selectedOptions,d=t.setOptions,u=t.onChange,h=e,h=n?e.map((function(e){return e[o||"value"]})).join(s||","):r?l?e.map((function(e){return e[o||"value"]})):e[0]&&e[0][o||"value"]||"":l?e:e[0],m=[],e.forEach((function(e){p()(a,(function(t){return e[o||"value"]==t[o||"value"]}))||m.push(e)})),m.length&&d(a.concat(m)),v=l?e:e[0],[4,c("change",(0,g.RKM)(this.props,{value:h,option:v,selectedItems:v}))];case 1:return(null==(f=i.sent())?void 0:f.prevented)||u(h),[2]}}))}))},t.prototype.handleItemClick=function(e){return(0,i.sH)(this,void 0,void 0,(function(){var t,n,o;return(0,i.YH)(this,(function(i){switch(i.label){case 0:return t=this.props,n=t.data,[4,(0,t.dispatchEvent)("itemClick",(0,g.ed2)(n,{item:e}))];case 1:return null==(o=i.sent())||o.prevented,[2]}}))}))},t.prototype.removeItem=function(e){return(0,i.sH)(this,void 0,void 0,(function(){var t,n,o,s,r,l,a,c,p,d,u,h,m,v;return(0,i.YH)(this,(function(f){switch(f.label){case 0:return t=this.props,n=t.selectedOptions,o=t.joinValues,s=t.extractValue,r=t.delimiter,l=t.valueField,a=t.onChange,c=t.multiple,p=t.dispatchEvent,d=n.concat(),u=(0,i.zs)(d.splice(e,1),1),h=u[0],m=d,m=o?d.map((function(e){return e[l||"value"]})).join(r||","):s?c?d.map((function(e){return e[l||"value"]})):d[0]&&d[0][l||"value"]||"":c?d:d[0],[4,p("change",(0,g.RKM)(this.props,{value:m,option:h,selectedItems:h}))];case 1:return(null==(v=f.sent())?void 0:v.prevented)||a(m),[2]}}))}))},t.prototype.handleKeyDown=function(e){var t=this.props.selectedOptions;" "===e.key?(this.open(),e.preventDefault()):t.length&&"Backspace"==e.key&&this.removeItem(t.length-1)},t.prototype.handleFocus=function(){this.setState({isFocused:!0})},t.prototype.handleBlur=function(){this.setState({isFocused:!1})},t.prototype.handleClick=function(){this.input.current&&this.input.current.focus(),this.open()},t.prototype.clearValue=function(){var e=this.props,t=e.onChange,n=e.resetValue;t(void 0!==n?n:"")},t.prototype.getOverflowConfig=function(){var e=this.props.overflowConfig;return f()(t.defaultProps.overflowConfig,e)},t.prototype.handleSelect=function(e,t){var n=this.props,i=n.selectedOptions,o=n.valueField;if(Array.isArray(e)&&Array.isArray(t)&&(e.length||t.length)){var s=k()(e,i,(function(e,t){var n=e[o||"value"],i=t[o||"value"];return n||i?n===i:u()(a()(e,"value"),a()(t,"value"))}));s.length===e.length&&s.length===i.length||this.handleChange(e)}},t.prototype.renderTag=function(e,t){var n=this,s=this.props,r=s.classPrefix,l=s.classnames,a=s.labelField,c=s.labelTpl;s.translate;var p=s.disabled,d=s.env,u=s.id,h=s.themeCss,m=s.css;return o.createElement("div",{key:t,className:l("".concat(r,"Picker-value"),(0,g.NH8)((0,i.Cl)((0,i.Cl)({},this.props),{name:"pickValueWrapClassName",id:u,themeCss:h||m})),{"is-disabled":p})},o.createElement("span",{className:l("".concat(r,"Picker-valueIcon"),(0,g.NH8)((0,i.Cl)((0,i.Cl)({},this.props),{name:"pickValueIconClassName",id:u,themeCss:h||m}))),onClick:function(e){e.stopPropagation(),n.removeItem(t)}},"×"),o.createElement("span",{className:l("".concat(r,"Picker-valueLabel"),(0,g.NH8)((0,i.Cl)((0,i.Cl)({},this.props),{name:"pickFontClassName",id:u,themeCss:h||m}))),onClick:function(t){t.stopPropagation(),n.handleItemClick(e)}},c?o.createElement(y.Ed,{html:(0,g.pbD)(c,e),filterHtml:d.filterHtml}):"".concat((0,g.dnO)(e,a||"label")||(0,g.dnO)(e,"id"))))},t.prototype.renderValues=function(){var e=this,t=this.props,n=t.classPrefix,s=t.selectedOptions,l=t.translate,c=t.disabled,p=t.multiple,d=t.popOverContainer,u=t.id,h=t.themeCss,m=t.css,v=this.getOverflowConfig(),f=v.maxTagCount,C=v.overflowTagPopover,k=s.length,S=s,b=!1!==p&&(0,g.z09)(f,{start:0,end:k,left:"inclusive",right:"exclusive"});return b&&(S=(0,i.fX)((0,i.fX)([],(0,i.zs)(s.slice(0,f)),!1),[{label:"+ ".concat(k-f," ..."),value:"__overflow_tag__"}],!1)),o.createElement("div",{className:"".concat(n,"Picker-values")},S.map((function(t,p){return b&&p===f?o.createElement(y.T_,{key:p,container:d,tooltip:(0,i.Cl)((0,i.Cl)({tooltipClassName:r()("Picker-overflow",null==C?void 0:C.tooltipClassName),title:l("已选项")},a()(C,["children","content","tooltipClassName"])),{children:function(){return o.createElement("div",{className:r()("".concat(n,"Picker-overflow-wrapper"))},s.slice(f,k).map((function(t,n){var i=n+f;return e.renderTag(t,i)})))}})},o.createElement("div",{key:p,className:r()("".concat(n,"Picker-value"),{"is-disabled":c})},o.createElement("span",{className:"".concat(n,"Picker-valueLabel ").concat((0,g.NH8)((0,i.Cl)((0,i.Cl)({},e.props),{name:"pickFontClassName",id:u,themeCss:h||m})))},t.label))):e.renderTag(t,p)})))},t.prototype.renderBody=function(e){var t=(void 0===e?{}:e).popOverContainer,n=this.props,o=n.render,s=n.selectedOptions,r=n.options,l=n.multiple,a=n.valueField,c=n.embed,p=n.source,d=n.strictMode,u=n.testIdBuilder,h=this.getOverflowConfig(),m=h.maxTagCount,v=h.overflowTagPopoverInCRUD,f=h.displayPosition;return o("modal-body",this.state.schema,(0,i.Cl)({value:s,valueField:a,primaryField:a,options:p?[]:r,multiple:l,strictMode:d,onSelect:c?this.handleSelect:void 0,testIdBuilder:null==u?void 0:u.getChild("body-schema"),ref:this.crudRef,popOverContainer:t},c||Array.isArray(f)&&f.includes("crud")?{maxTagCount:m,overflowTagPopover:v}:{}))},t.prototype.render=function(){var e=this.props,t=e.className;e.style;var n=e.modalClassName,s=e.classnames,r=e.disabled,l=e.render,a=e.modalMode,c=e.source,p=e.size,d=e.clearable,u=e.multiple,h=e.placeholder,m=e.embed,v=e.selectedOptions,f=e.translate,C=e.popOverContainer,k=e.modalTitle,S=e.data,b=e.mobileUI,F=e.env,O=e.themeCss,N=e.css,P=e.id,w=e.classPrefix,I=e.testIdBuilder;return o.createElement("div",{className:s("PickerControl",{"is-mobile":b},t)},m?o.createElement("div",{className:s("Picker")},this.renderBody({popOverContainer:C})):o.createElement("div",{className:s("Picker",{"Picker--single":!u,"Picker--multi":u,"is-focused":this.state.isFocused,"is-disabled":r})},o.createElement("div",{onClick:this.handleClick,className:s("Picker-input",r&&"is-disabled",this.state.isFocused&&"is-focused",(0,g.NH8)((0,i.Cl)((0,i.Cl)({},this.props),{name:"pickControlClassName",id:P,themeCss:O||N})))},!v.length&&h?o.createElement("div",{className:s("Picker-placeholder")},f(h)):null,o.createElement("div",(0,i.Cl)({className:s("Picker-valueWrap")},null==I?void 0:I.getTestId()),this.renderValues(),o.createElement("input",{onChange:g.lQ1,value:"",ref:this.input,onKeyDown:this.handleKeyDown,onFocus:this.handleFocus,onBlur:this.handleBlur,readOnly:b})),d&&!r&&v.length?o.createElement("a",{onClick:this.clearValue,className:s("Picker-clear")},o.createElement(y.In,{icon:"input-clear",className:"icon"})):null,o.createElement("span",(0,i.Cl)({onClick:this.open,className:s("Picker-btn")},null==I?void 0:I.getChild("picker-open-btn").getTestId()),o.createElement(y.In,{icon:"window-restore",className:s("icon",(0,g.NH8)((0,i.Cl)((0,i.Cl)({},this.props),{name:"pickIconClassName",id:P,themeCss:O||N}))),iconContent:"Picker-icon"}))),l("modal",{title:k&&"string"==typeof k?(0,g.pbD)(k,S):f("Select.placeholder"),size:p,type:a,className:n,body:{children:this.renderBody},testIdBuilder:null==I?void 0:I.getChild("modal")},{key:"modal",lazyRender:!!c,onConfirm:this.handleModalConfirm,onClose:this.close,show:this.state.isOpened})),o.createElement(g.z4D,(0,i.Cl)({},this.props,{config:{themeCss:O||N,classNames:[{key:"pickControlClassName",weights:{default:{important:!0},hover:{important:!0},focused:{important:!0,parent:".".concat(w,"Picker.is-focused >")},disabled:{important:!0,parent:".".concat(w,"Picker.is-disabled >")}}},{key:"pickFontClassName"},{key:"pickValueWrapClassName",weights:{default:{important:!0}}},{key:"pickValueIconClassName",weights:{default:{important:!0},hover:{important:!0}}},{key:"pickIconClassName",weights:{default:{suf:" svg"}}}],id:P},env:F})))},t.propsList=["modalTitle","modalMode","pickerSchema","labelField","onChange","options","value","inline","multiple","embed","resetValue","placeholder","onQuery"],t.defaultProps={modalMode:"dialog",multiple:!1,placeholder:"Picker.placeholder",labelField:"label",valueField:"value",pickerSchema:{mode:"list"},embed:!1,overflowConfig:{maxTagCount:-1,displayPosition:["select","crud"],overflowTagPopover:{placement:"top",trigger:"hover",showArrow:!1,offset:[0,-10]},overflowTagPopoverInCRUD:{placement:"bottom",trigger:"hover",showArrow:!1,offset:[0,10]}}},(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",Object)],t.prototype,"fetchOptions",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[Object]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"crudRef",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"open",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"close",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[Array,Object,Object,Array]),(0,i.Sn)("design:returntype",Promise)],t.prototype,"handleModalConfirm",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[Array]),(0,i.Sn)("design:returntype",Promise)],t.prototype,"handleChange",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[Object]),(0,i.Sn)("design:returntype",Promise)],t.prototype,"handleItemClick",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[Object]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"handleKeyDown",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"handleFocus",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"handleBlur",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"handleClick",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"clearValue",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[Array,Array]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"handleSelect",null),(0,i.Cg)([g.d6t,(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[Object]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"renderBody",null),(0,i.Cg)([(0,S.E)(),(0,i.Sn)("design:type",Function),(0,i.Sn)("design:paramtypes",[]),(0,i.Sn)("design:returntype",void 0)],t.prototype,"render",null),t}(o.PureComponent),O=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,i.C6)(t,e),(0,i.Cg)([(0,g.QqA)({type:"picker",autoLoadOptionsFromSource:!1,sizeMutable:!1})],t)}(F)}}]);